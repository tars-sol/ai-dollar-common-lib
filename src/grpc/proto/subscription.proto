syntax = "proto3";

package subscription;

service SubscriptionService {
  rpc CreateTier        (CreateTierRequest)        returns (SubscriptionTierResponse);
  rpc UpdateTier        (UpdateTierRequest)        returns (SubscriptionTierResponse);
  rpc UpdateTierPrices  (UpdateTierPricesRequest)  returns (SubscriptionTierResponse);
  rpc ToggleTierActive  (ToggleTierActiveRequest)  returns (SubscriptionTierResponse);
  rpc GetTier           (GetTierRequest)           returns (SubscriptionTierResponse);
  rpc GetCreatorTiers   (GetCreatorTiersRequest)   returns (GetCreatorTiersResponse);
  rpc DeleteTier        (DeleteTierRequest)        returns (SuccessResponse);
  rpc CreateCheckoutSession (CreateCheckoutSessionRequest) returns (CreateCheckoutSessionResponse);
  rpc CreateCheckoutSecret (CreateCheckoutSecretRequest)   returns (CreateCheckoutSecretResponse);
  rpc HandleSubscriptionPayment(SubscriptionPaymentRequest) returns (SuccessResponse);

  rpc CancelSubscription         (CancelSubscriptionRequest)         returns (SuccessResponse);
  rpc ChangeSubscriptionInterval (ChangeSubscriptionIntervalRequest) returns (SuccessResponse);

  rpc GetUserSubscriptions (GetUserSubscriptionsRequest) returns (GetUserSubscriptionsResponse);
}

message SuccessResponse {
  bool success = 1;
}

message CreateTierRequest {
  string  creatorId = 1;
  string  name = 2;
  optional string description = 3;
  optional int32  accessMask = 4; 
  optional string currency   = 5; 
  int32  monthlyPriceCents = 6;         
  int32  annualPriceCents  = 7;
}

message UpdateTierRequest {
  string  tierId = 1;
  optional string name        = 2;
  optional string description = 3;
  optional int32  accessMask  = 4;
  optional string currency    = 5;
}

message UpdateTierPricesRequest {
  string tierId = 1;
  optional int32 monthlyPriceCents = 2;
  optional int32 annualPriceCents  = 3;
}

message ToggleTierActiveRequest {
  string tierId = 1;
  bool   isActive = 2;
}

message GetTierRequest {
  string tierId = 1;
}

message GetCreatorTiersRequest {
  string  creatorId = 1;
  optional bool    onlyActive = 2;
}

message GetCreatorTiersResponse {
  repeated SubscriptionTierResponse tiers = 1;
}

message DeleteTierRequest {
  string tierId    = 1;
  string creatorId = 2;
}

message SubscriptionTierResponse {
  string id = 1;
  string creatorId = 2;
  string name = 3;
  optional string description = 4;

  string stripeProductId      = 5;  
  string monthlyStripePriceId = 6;  
  int32  monthlyPriceCents    = 7;  
  string annualStripePriceId  = 8;  
  int32  annualPriceCents     = 9;  

  string currency = 10;
  int32  accessMask = 11;
  bool   isActive   = 12;
  string createdAt  = 13;
  string updatedAt  = 14;

  optional string creatorName      = 15;
  optional string creatorAvatarUrl = 16;
}

message CreateCheckoutSessionRequest {
  string userId = 1;               
  string tierId = 2;              
  string interval = 3;    
}

message CreateCheckoutSessionResponse {
  string url       = 1; 
  string sessionId = 2;
}

message CreateCheckoutSecretRequest {
  string userId = 1;
  string tierId = 2;
  string interval = 3;
  string role = 4;
  string roleId = 5;
}

message CreateCheckoutSecretResponse {
  string clientSecretKey = 1; 
}

message SubscriptionPaymentRequest {
  string eventId = 1;            
  string invoiceId = 2;          
  string subscriptionId = 3;     
  string customerId = 4;         

  string amountPaid = 5;         
  string currency = 6;           

  int64 periodStart = 7;         
  int64 periodEnd = 8;           
  int64 paidAt = 9;              

  string userId = 10;            
  string creatorId = 11;         
  string tierId = 12;            
  string interval = 13;     
  string role = 14;
  string roleId = 15;     
}

message CancelSubscriptionRequest {
  string userId    = 1;
  string creatorId = 2;
}

message ChangeSubscriptionIntervalRequest {
  string userId    = 1;
  string creatorId = 2;
  string interval  = 3;
}

message GetUserSubscriptionsRequest {
  string userId = 1;
  optional bool onlyActive = 2;
}

message GetUserSubscriptionsResponse {
  repeated UserSubscriptionItem subscriptions = 1;
}

message UserSubscriptionItem {
  string creatorId = 1;

  string creatorName = 2;
  string creatorUsername = 3;
  optional string creatorAvatarUrl = 4;

  string tierName = 5;
  string subscriptionType = 6;
  int32 subscriptionChargesCents = 7;
  string currency = 8;
  string status = 9;
  string startedAt = 10;
  string nextBillingAt = 11;
  bool cancelAtPeriodEnd = 12;
}